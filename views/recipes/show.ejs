<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
</head>

<body>
    <%- include('../partials/header') %>
        <% recipe.forEach((recipe_info)=> {%>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-6">
                        <header class="container mt-5 mx-3 px-5">
                            <h1>
                                <%=recipe_info['r_title']%>
                            </h1>
                            <p>
                                <%=recipe_info['description']%>
                            </p>
                            <p>
                                <span id="star-rating-container">
                                    <i class="bi bi-star" data-star="1"></i> 
                                    <i class="bi bi-star" data-star="2"></i> 
                                    <i class="bi bi-star" data-star="3"></i> 
                                    <i class="bi bi-star" data-star="4"></i> 
                                    <i class="bi bi-star" data-star="5"></i> 
                                </span>
                                Rating # | <%= recipe_info['comments_count'] %> comments | Number of photos</p>
                            <div class="col">
                                <div class="row">
                                    <div class="col">
                                        <div class="row">
                                            <p class="mb-0">Prep Time</p>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <%=recipe_info['prep_time']%> minutes
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="row">
                                            <p class="mb-0">Cook Time</p>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <%=recipe_info['cook_time']%> minutes
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="row">
                                            <p class="mb-0">Total Time</p>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <%=parseInt(recipe_info['prep_time']) +
                                                    parseInt(recipe_info['cook_time'])%>
                                                    minutes
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <p>
                                            Servings <%=recipe_info['servings']%>
                                        </p>
                                    </div>
                                    <div class="col">
                                        <p>Author: <%=`${recipe_info['submit_user_first_name']}`%>
                                                <%=`${recipe_info['submit_user_last_name']}`%>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <div class="mx-3 px-5 mb-4">
                            <p class="fw-semibold fs-5 mb-1">Ingredients</p>
                            <p>
                                <%= recipe_info['ingredients'] %>
                            </p>
                        </div>
                        <div class="mx-3 px-5">
                            <p class="fw-semibold fs-5 mb-1">Directions</p>
                            <p>
                                <%= recipe_info['directions'] %>
                            </p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row mt-5 me-3 pe-5">
                            <div class="bg-secondary-subtle py-5" id="imageFrame">
                                <p class="text-center">IMAGE GOES HERE</p>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col">
                                <div class="row">
                                    <div class="me-3 pe-5 float-end">
                                        <%if(currentUser && currentUser.id === recipe_info['submit_user_id']) {%>
                                            <a href="<%=`/recipes/${recipe_info['id']}/edit`%>"
                                                class="btn btn-dark">Edit</a>
                                            <a href="<%=`/recipes/${recipe_info['id']}/delete`%>"
                                                onclick="return confirm('Are you sure you want to delete this recipe?');"
                                                class="btn btn-dark"
                                                id="deleteBtn">Delete</a>

                                            <script>
                                                const queryString = '<%-`[id*="comment-user-${currentUser.id}"]`%>'
                                                const userCommentElement = document.querySelectorAll(queryString);
                                                const deleteButton = document.getElementById('deleteBtn');
                                                const editCommentBtn = document.createElement('button')
                                                const commentBtn = document.createElement('button')

                                                if (userCommentElement) {
                                                    deleteButton.after(editCommentBtn);
                                                    editCommentBtn.innerText = 'Edit Comment';
                                                    editCommentBtn.setAttribute('type', 'button');
                                                    editCommentBtn.setAttribute('id', 'editBtn');
                                                    editCommentBtn.classList.add('btn', 'btn-dark', 'ms-1')

                                                    const editBtn = document.getElementById('editBtn')
                                                    editBtn.addEventListener('click', e => {
                                                        userCommentElement.scrollIntoView();
                                                    })

                                                } else {
                                                    console.log('No comment made by user');
                                                    deleteButton.after(commentBtn);
                                                    commentBtn.innerText = 'Comment';
                                                    commentBtn.setAttribute('type', 'button');
                                                    commentBtn.setAttribute('id', 'createComment');
                                                    commentBtn.classList.add('btn', 'btn-dark', 'ms-1')
                                                }
                                            </script>
                                        <%} else if (locals.currentUser){%>      
                                            <p>Updated on
                                                <%=dayjs(`${recipe_info['created_at']}`).format("MMMM DD, YYYY")%>
                                            </p>
                                        <%} else {%>
                                            <a href="<%=`/login/recipes/${recipe_info['id']}`%>" class="btn btn-dark">Login to comment</a>
                                            <p>Updated on
                                                <%=dayjs(`${recipe_info['created_at']}`).format("MMMM DD, YYYY")%>
                                            </p>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="container mt-5 mx-3 px-5">
                            <form action="<%=`/recipes/comment/${recipe_info['id']}`%>" method="POST">
                                <div class="row mt-4" id="commentForm"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>
                <% comments.forEach((comment)=> {%>
                    <div class="container" id="<%=`comment-container-${comment['id']} comment-user-${comment['user_id']}`%>">
                        <div class="col comment-area comment-background" id="">
                            <div class="col">
                                <div class="row">
                                    <div class="col-10">
                                        <h6 class="ms-4 mb-0 pt-4 fw-semibold">
                                            <%=comment['first_name']%>
                                                <%=comment['last_name']%>
                                        </h6>
                                        <h6>
                                            <h6 class="ms-4 pb-2 fw-light">
                                                <%const createdAt=comment['created_at']%>
                                                    <%='Commented'%>
                                                        <%=dayjs(createdAt).fromNow();%>
                                            </h6>
                                        </h6>
                                    </div>
                                    <div class="col-2" id="<%=`comment-${comment['id']}-like-container`%>">
                                        <h6 id="<%=`comment-${comment['id']}-like-count`%>">
                                            <%=comment['comment_likes']%>
                                        </h6>
                                        <a href=""></a>
                                        <button type="button" class="btn btn-dark mt-2 like-comment-btn"
                                            id="<%=`comment-${comment['id']}-like-btn`%>"
                                            data-comment-id="<%= comment['id']%>">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                                <path
                                                    d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <h6 id="<%=`comment-${comment['id']}`%>" class=" ms-4 fw-normal">
                                    <%=comment['comment']%>
                                </h6>
                            </div>
                            <form action="<%=`/recipes/${comment['recipe_id']}/comment/edit/${comment['id']}`%>"
                                method="POST" class="mx-4">
                            </form>
                            <div class="row">
                                <div class="col me-3 mb-3">
                                    <div class="float-end">
                                        <% if(currentUser && currentUser.id===comment['user_id']) { %>
                                            <button type="button" class="btn btn-dark edit-comment-btn"
                                                id="<%=`comment-edit-button-id-${comment['id']}`%>"
                                                data-comment-id="<%= comment['id']%>">Edit</button>
                                            <button type="button" class="btn btn-dark cancel-edit-btn d-none my-3 mx-1 float-end">Cancel</button>
                                            <button type="submit" class="btn btn-dark submit-edit-btn d-none my-3 float-end">Submit</button>
                                            <a href="<%=`/recipes/${comment['recipe_id']}/comment/delete/${comment['id']}`%>"
                                                onclick="return confirm('Are you sure you want to delete this comment?');"
                                                class="btn btn-dark"
                                                id="<%=`comment-delete-button-id-${comment['id']}`%>">Delete</a>
                                            <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <hr class="solid mt-3">
                        </div>
                    </div>
                    <% }); %>
</div>
 <div id="editorjs"></div>

</body>

<script src="/javascripts/star_rating.js" type="text/javascript"></script>

<script src="/javascripts/comments.js" type="text/javascript"></script>

<script src="/javascripts/comment_likes.js" type="text/javascript"></script>

</html>