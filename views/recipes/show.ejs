<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
</head>

<body>
    <%- include('../partials/header') %>
        <% recipe.forEach((recipe_info)=> {%>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-6">
                        <header class="container mt-5 mx-3 px-5">
                            <h1>
                                <%=recipe_info['r_title']%>
                            </h1>
                            <p>
                                <%=recipe_info['description']%>
                            </p>
                            <p>
                                <span id="star-rating-container">
                                    <i class="bi bi-star" data-star="1" data-url="<%=`/recipes/${recipe_info['id']}/rating/`%>"></i> 
                                    <i class="bi bi-star" data-star="2" data-url="<%=`/recipes/${recipe_info['id']}/rating/`%>"></i> 
                                    <i class="bi bi-star" data-star="3" data-url="<%=`/recipes/${recipe_info['id']}/rating/`%>"></i> 
                                    <i class="bi bi-star" data-star="4" data-url="<%=`/recipes/${recipe_info['id']}/rating/`%>"></i> 
                                    <i class="bi bi-star" data-star="5" data-url="<%=`/recipes/${recipe_info['id']}/rating/`%>"></i> 
                                </span>
                                Rating # | <%= recipe_info['comments_count'] %> comments | Number of photos</p>
                            <div class="col">
                                <div class="row">
                                    <div class="col">
                                        <div class="row">
                                            <p class="mb-0">Prep Time</p>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <%=recipe_info['prep_time']%> minutes
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="row">
                                            <p class="mb-0">Cook Time</p>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <%=recipe_info['cook_time']%> minutes
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="row">
                                            <p class="mb-0">Total Time</p>
                                        </div>
                                        <div class="row">
                                            <p>
                                                <%=parseInt(recipe_info['prep_time']) +
                                                    parseInt(recipe_info['cook_time'])%>
                                                    minutes
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <p>
                                            Servings <%=recipe_info['servings']%>
                                        </p>
                                    </div>
                                    <div class="col">
                                        <p>Author: <%=`${recipe_info['submit_user_first_name']}`%>
                                                <%=`${recipe_info['submit_user_last_name']}`%>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <div class="mx-3 px-5 mb-4">
                            <p class="fw-semibold fs-5 mb-1">Ingredients</p>
                            <p>
                                <%= recipe_info['ingredients'] %>
                            </p>
                        </div>
                        <div class="mx-3 px-5">
                            <p class="fw-semibold fs-5 mb-1">Directions</p>
                            <p>
                                <%= recipe_info['directions'] %>
                            </p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="row mt-5 me-3 pe-5">
                            <div class="bg-secondary-subtle py-5" id="imageFrame">
                                <p class="text-center">IMAGE GOES HERE</p>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col">
                                <div class="row">
                                    <div class="me-3 pe-5 float-end">
                                        <%if(currentUser && currentUser.id === recipe_info['submit_user_id']) {%>
                                            <a href="<%=`/recipes/${recipe_info['id']}/edit`%>"
                                                class="btn btn-dark">Edit</a>
                                            <a href="<%=`/recipes/${recipe_info['id']}/delete`%>"
                                                onclick="return confirm('Are you sure you want to delete this recipe?');"
                                                class="btn btn-dark"
                                                id="deleteBtn">Delete</a>

                                            <% const userComment = comments.find((comment) => comment['user_id'] == currentUser.id) %>
                                            <% if (userComment) { %>
                                                <button type="button" class="btn btn-dark" id="editButton" data-container-id="<%-`comment-container-${userComment['id']}`%>">Edit Comment</button>
                                            <% } else {%>
                                                <button type="button" class="btn btn-dark" id="createComment">Comment</button>
                                            <% } %>
                                            <script>
                                                const editButton = document.querySelector('#editButton');
                                                editButton.addEventListener('click', e => {
                                                    const commentContainer = document.getElementById(editButton.dataset.containerId);
                                                    commentContainer.scrollIntoView();
                                                })
                                            </script>

                                        <%} else if (locals.currentUser){%>      
                                            <p>Updated on
                                                <%=dayjs(`${recipe_info['created_at']}`).format("MMMM DD, YYYY")%>
                                            </p>
                                        <%} else {%>
                                            <a href="<%=`/login/recipes/${recipe_info['id']}`%>" class="btn btn-dark">Login to comment</a>
                                            <p>Updated on
                                                <%=dayjs(`${recipe_info['created_at']}`).format("MMMM DD, YYYY")%>
                                            </p>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="container mt-5 mx-3 px-5">
                            <form action="<%=`/recipes/comment/${recipe_info['id']}`%>" method="POST">
                                <div class="row mt-4" id="commentForm"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>
                <% comments.forEach((comment)=> {%>
                    <div class="container" id="<%=`comment-container-${comment['id']}`%>">
                        <div class="col comment-area comment-background" id="">
                            <div class="col">
                                <div class="row">
                                    <div class="col-10">
                                        <h6 class="ms-4 mb-0 pt-4 fw-semibold">
                                            <%=comment['first_name']%>
                                                <%=comment['last_name']%>
                                        </h6>
                                        <h6>
                                            <h6 class="ms-4 pb-2 fw-light">
                                                <%const createdAt=comment['created_at']%>
                                                    <%='Commented'%>
                                                        <%=dayjs(createdAt).fromNow();%>
                                            </h6>
                                        </h6>
                                    </div>
                                    <div class="col-2" id="<%=`comment-${comment['id']}-like-container`%>">
                                        <button class="btn btn-dark mt-2 like-comment-btn" id="<%=`comment-${comment['id']}-like-btn`%>" data-comment-id="<%= comment['id']%>" data-url="<%=`/recipes/${comment['recipe_id']}/comment/like/${comment['id']}`%>">
                                                <div class="row align-items-center">
                                                    <div class="col">
                                                        <h6 id="<%=`comment-${comment['id']}-like-count`%>" class="mb-0">
                                                            <%=comment['likes']%>
                                                        </h6>
                                                    </div>
                                                    <div class="col">
                                                        <i class="bi bi-hand-thumbs-up"></i>
                                                    </div>
                                                </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <h6 id="<%=`comment-${comment['id']}`%>" class=" ms-4 fw-normal">
                                    <%=comment['comment']%>
                                </h6>
                            </div>
                            <form action="<%=`/recipes/${comment['recipe_id']}/comment/edit/${comment['id']}`%>"
                                method="POST" class="mx-4">
                            </form>
                            <div class="row">
                                <div class="col me-3 mb-3">
                                    <div class="float-end">
                                        <% if(currentUser && currentUser.id===comment['user_id']) { %>
                                            <button type="button" class="btn btn-dark edit-comment-btn"
                                                id="<%=`comment-edit-button-id-${comment['id']}`%>"
                                                data-comment-id="<%= comment['id']%>">Edit</button>
                                            <button type="button" class="btn btn-dark cancel-edit-btn d-none my-3 mx-1 float-end">Cancel</button>
                                            <button type="submit" class="btn btn-dark submit-edit-btn d-none my-3 float-end">Submit</button>
                                            <a href="<%=`/recipes/${comment['recipe_id']}/comment/delete/${comment['id']}`%>"
                                                onclick="return confirm('Are you sure you want to delete this comment?');"
                                                class="btn btn-dark"
                                                id="<%=`comment-delete-button-id-${comment['id']}`%>">Delete</a>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <hr class="solid mt-3">
                        </div>
                    </div>
                    <% }); %>
</body>

<script src="/javascripts/star_rating.js" type="text/javascript"></script>

<script src="/javascripts/comments.js" type="text/javascript"></script>

<script src="/javascripts/comment_likes.js" type="text/javascript"></script>

</html>